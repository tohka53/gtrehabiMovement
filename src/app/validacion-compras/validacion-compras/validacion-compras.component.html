<!-- src/app/components/validacion-compras/validacion-compras.component.html -->

<div class="validacion-compras-container">
  <!-- Header Principal -->
  <div class="header-mejorado animacion-slide-down">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
      <div>
        <h1 class="titulo-principal-mejorado">
          <i class="fas fa-check-circle"></i>
          Validación de Compras
        </h1>
        <p class="subtitulo-mejorado">Administración y validación de compras de paquetes</p>
      </div>
      
      <button 
        type="button" 
        class="boton-actualizar-mejorado"
        (click)="cargarComprasPendientes()"
        [disabled]="cargando">
        <i class="fas fa-sync-alt" [class.fa-spin]="cargando"></i>
        <span>Actualizar</span>
      </button>
    </div>
  </div>

  <!-- Estadísticas -->
  <div *ngIf="estadisticas && puedeValidar" class="estadisticas-grid-mejorada animacion-slide-up">
    <div class="tarjeta-estadistica-mejorada pendientes hover-lift">
      <div class="estadistica-contenido">
        <div class="estadistica-info">
          <h6>Pendientes</h6>
          <div class="estadistica-valor">{{ estadisticas.compras_pendientes }}</div>
        </div>
        <i class="fas fa-clock estadistica-icono pendientes"></i>
      </div>
    </div>

    <div class="tarjeta-estadistica-mejorada validadas hover-lift">
      <div class="estadistica-contenido">
        <div class="estadistica-info">
          <h6>Validadas</h6>
          <div class="estadistica-valor">{{ estadisticas.compras_validadas }}</div>
        </div>
        <i class="fas fa-check estadistica-icono validadas"></i>
      </div>
    </div>

    <div class="tarjeta-estadistica-mejorada monto hover-lift">
      <div class="estadistica-contenido">
        <div class="estadistica-info">
          <h6>Monto Pendiente</h6>
          <div class="estadistica-valor">{{ formatearPrecio(estadisticas.monto_total_pendiente) }}</div>
        </div>
        <i class="fas fa-dollar-sign estadistica-icono monto"></i>
      </div>
    </div>

    <div class="tarjeta-estadistica-mejorada tiempo hover-lift">
      <div class="estadistica-contenido">
        <div class="estadistica-info">
          <h6>Tiempo Promedio</h6>
          <div class="estadistica-valor">{{ estadisticas.promedio_tiempo_validacion }}h</div>
        </div>
        <i class="fas fa-stopwatch estadistica-icono tiempo"></i>
      </div>
    </div>
  </div>

  <!-- Mensaje sin permisos -->
  <div *ngIf="!puedeValidar" class="alerta-mejorada warning">
    <i class="fas fa-exclamation-triangle"></i>
    <span>No tienes permisos para validar compras. Esta sección es solo para administradores.</span>
  </div>

  <!-- Contenido principal -->
  <div *ngIf="puedeValidar">
    <!-- Filtros -->
    <div class="seccion-filtros-mejorada">
      <h2 class="titulo-filtros-mejorado">
        <i class="fas fa-filter"></i>
        Filtros de búsqueda
      </h2>
      
      <div class="filtros-row">
        <div class="grupo-filtro-mejorado">
          <label for="filtroEstado">Estado</label>
          <select 
            id="filtroEstado"
            class="select-mejorado"
            [(ngModel)]="filtros.estado_compra"
            (change)="aplicarFiltros()">
            <option *ngFor="let estado of estadosCompra" [value]="estado.value">
              {{ estado.label }}
            </option>
          </select>
        </div>

        <div class="grupo-filtro-mejorado">
          <label for="filtroMetodo">Método de Pago</label>
          <select 
            id="filtroMetodo"
            class="select-mejorado"
            [(ngModel)]="filtros.metodo_pago"
            (change)="aplicarFiltros()">
            <option value="">Todos los métodos</option>
            <option *ngFor="let metodo of metodosPago" [value]="metodo.value">
              {{ metodo.label }}
            </option>
          </select>
        </div>

        <div class="grupo-filtro-mejorado">
          <label for="filtroFechaDesde">Desde</label>
          <input
            type="date"
            id="filtroFechaDesde"
            class="input-mejorado"
            [(ngModel)]="filtros.fecha_desde"
            (change)="aplicarFiltros()">
        </div>

        <div class="grupo-filtro-mejorado">
          <label for="filtroFechaHasta">Hasta</label>
          <input
            type="date"
            id="filtroFechaHasta"
            class="input-mejorado"
            [(ngModel)]="filtros.fecha_hasta"
            (change)="aplicarFiltros()">
        </div>
      </div>

      <div class="botones-filtro-mejorados">
        <span class="contador-resultados-mejorado">
          {{ totalItems }} compra{{ totalItems !== 1 ? 's' : '' }} encontrada{{ totalItems !== 1 ? 's' : '' }}
        </span>
        <button 
          type="button" 
          class="boton-limpiar-mejorado"
          (click)="limpiarFiltros()">
          <i class="fas fa-times"></i>
          <span>Limpiar filtros</span>
        </button>
      </div>
    </div>

    <!-- Estado de carga -->
    <div *ngIf="cargando" class="estado-carga-mejorado">
      <div class="spinner-mejorado"></div>
      <p class="texto-carga-mejorado">Cargando compras pendientes...</p>
    </div>

    <!-- Error -->
    <div *ngIf="error && !cargando" class="alerta-mejorada error">
      <i class="fas fa-exclamation-triangle"></i>
      <div>
        <span>{{ error }}</span>
        <button 
          type="button" 
          class="btn btn-sm btn-outline-danger ms-2"
          (click)="cargarComprasPendientes()">
          <i class="fas fa-redo me-1"></i>
          Reintentar
        </button>
      </div>
    </div>

    <!-- Sin resultados -->
    <div *ngIf="!cargando && !error && comprasFiltradas.length === 0" class="sin-resultados-mejorado">
      <i class="fas fa-inbox icono-sin-resultados-mejorado"></i>
      <h5 class="titulo-sin-resultados-mejorado">No se encontraron compras</h5>
      <p class="descripcion-sin-resultados-mejorado">No hay compras que coincidan con los filtros aplicados</p>
    </div>

    <!-- Tabla de compras -->
    <div *ngIf="!cargando && !error && comprasFiltradas.length > 0" class="contenedor-tabla-mejorado">
      <div class="scrollbar-personalizado" style="overflow-x: auto;">
        <table class="tabla-mejorada">
          <thead>
            <tr>
              <th>Compra</th>
              <th>Usuario</th>
              <th>Paquete</th>
              <th>Método de Pago</th>
              <th>Monto</th>
              <th>Fecha</th>
              <th>Estado</th>
              <th>Comprobante</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let compra of comprasFiltradas">
              <td>
                <div class="celda-compra-mejorada">
                  <div class="numero-compra-mejorado">#{{ compra.compra_id }}</div>
                  <div class="tiempo-transcurrido-mejorado">{{ calcularTiempoTranscurrido(compra.horas_desde_compra) }} ago</div>
                </div>
              </td>
              
              <td>
                <div class="celda-usuario-mejorada">
                  <div class="nombre-usuario-mejorado">{{ compra.usuario_nombre }}</div>
                  <div class="username-usuario-mejorado">{{ compra.usuario_username }}</div>
                </div>
              </td>
              
              <td>
                <div class="celda-paquete-mejorada">
                  <div class="nombre-paquete-mejorado">{{ compra.paquete_nombre }}</div>
                  <span class="badge-mejorado" [ngClass]="compra.paquete_tipo">
                    {{ compra.paquete_tipo | titlecase }}
                  </span>
                </div>
              </td>
              
              <td>
                <div class="metodo-pago-mejorado">
                  <i [class]="obtenerIconoMetodoPago(compra.metodo_pago)" 
                     [ngClass]="obtenerClaseMetodoPago(compra.metodo_pago)" 
                     class="icono-metodo-mejorado"></i>
                  <div class="info-metodo-mejorado">
                    <div class="label-metodo-mejorado">{{ obtenerLabelMetodoPago(compra.metodo_pago) }}</div>
                    <div *ngIf="compra.numero_transaccion" class="numero-transaccion-mejorado">
                      {{ compra.numero_transaccion }}
                    </div>
                  </div>
                </div>
              </td>
              
              <td>
                <div class="celda-monto-mejorada">
                  <div class="precio-final-mejorado">{{ formatearPrecio(compra.precio_final) }}</div>
                  <div *ngIf="compra.descuento_aplicado > 0">
                    <div class="precio-original-mejorado">
                      {{ formatearPrecio(compra.precio_paquete) }}
                    </div>
                    <div class="descuento-aplicado-mejorado">
                      -{{ formatearPrecio(compra.descuento_aplicado) }}
                    </div>
                  </div>
                </div>
              </td>
              
              <td>
                <div class="celda-fecha">
                  <div class="fecha-compra">{{ formatearFecha(compra.fecha_compra) }}</div>
                  <div *ngIf="compra.fecha_pago" class="fecha-pago">
                    Pago: {{ compra.fecha_pago }}
                    <span *ngIf="compra.hora_pago"> {{ compra.hora_pago }}</span>
                  </div>
                </div>
              </td>
              
              <td>
                <span class="badge-estado-mejorado" [ngClass]="compra.estado_compra">
                  {{ compra.estado_descripcion }}
                </span>
              </td>
              
              <td>
                <div class="tooltip-container" *ngIf="compra.tiene_comprobante">
                  <button 
                    type="button" 
                    class="boton-accion-mejorado boton-comprobante-mejorado"
                    (click)="verComprobante(compra)">
                    <i class="fas fa-file-image"></i>
                  </button>
                  <span class="tooltip-text">Ver comprobante</span>
                </div>
                <span *ngIf="!compra.tiene_comprobante" class="text-muted small">
                  Sin comprobante
                </span>
              </td>
              
              <td>
                <div class="botones-accion-mejorados">
                  <div class="tooltip-container" *ngIf="compra.estado_compra === 'pendiente'">
                    <button 
                      type="button" 
                      class="boton-accion-mejorado boton-validar-mejorado"
                      (click)="abrirModalValidacion(compra)">
                      <i class="fas fa-check"></i>
                    </button>
                    <span class="tooltip-text">Validar/Rechazar</span>
                  </div>
                  
                  <div class="tooltip-container">
                    <button 
                      type="button" 
                      class="boton-accion-mejorado boton-detalles-mejorado">
                      <i class="fas fa-eye"></i>
                    </button>
                    <span class="tooltip-text">Ver detalles</span>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Paginación -->
      <nav *ngIf="totalPaginas > 1" class="paginacion-mejorada">
        <button 
          class="item-paginacion-mejorado" 
          [ngClass]="{'deshabilitado': paginaActual === 1}"
          [disabled]="paginaActual === 1"
          (click)="cambiarPagina(paginaActual - 1)">
          Anterior
        </button>
        
        <button 
          *ngFor="let pagina of paginasArray"
          class="item-paginacion-mejorado" 
          [ngClass]="{'activo': pagina === paginaActual}"
          (click)="cambiarPagina(pagina)">
          {{ pagina }}
        </button>
        
        <button 
          class="item-paginacion-mejorado" 
          [ngClass]="{'deshabilitado': paginaActual === totalPaginas}"
          [disabled]="paginaActual === totalPaginas"
          (click)="cambiarPagina(paginaActual + 1)">
          Siguiente
        </button>
      </nav>
    </div>
  </div>
</div>

<!-- Modal de validación -->
<div *ngIf="mostrarModalValidacion" class="modal-overlay-mejorado" (click)="cerrarModalValidacion()">
  <div class="modal-contenido-mejorado scrollbar-personalizado" (click)="$event.stopPropagation()">
    <div class="modal-header-mejorado">
      <h5 class="modal-titulo-mejorado">
        <i class="fas fa-check-circle"></i>
        Validar Compra #{{ compraSeleccionada?.compra_id }}
      </h5>
      <button type="button" class="boton-cerrar-mejorado" (click)="cerrarModalValidacion()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body-mejorado">
      <!-- Información de la compra -->
      <div *ngIf="compraSeleccionada" class="info-compra-mejorada">
        <div class="info-compra-grid-mejorada">
          <div class="info-grupo-mejorado">
            <div class="info-item-mejorado">
              <h6>Usuario</h6>
              <div class="info-valor-mejorado">{{ compraSeleccionada.usuario_nombre }}</div>
              <div class="info-secundario-mejorado">{{ compraSeleccionada.usuario_username }}</div>
            </div>

            <div class="info-item-mejorado">
              <h6>Paquete</h6>
              <div class="info-valor-mejorado">{{ compraSeleccionada.paquete_nombre }}</div>
              <div class="mt-2">
                <span class="badge-mejorado" [ngClass]="compraSeleccionada.paquete_tipo">
                  {{ compraSeleccionada.paquete_tipo | titlecase }}
                </span>
              </div>
            </div>

            <div class="info-item-mejorado">
              <h6>Método de Pago</h6>
              <div class="d-flex align-items-center gap-2 mb-2">
                <i [class]="obtenerIconoMetodoPago(compraSeleccionada.metodo_pago)" class="fs-5"></i>
                <span class="info-valor-mejorado">{{ obtenerLabelMetodoPago(compraSeleccionada.metodo_pago) }}</span>
              </div>
              <div *ngIf="compraSeleccionada.numero_transaccion" class="info-secundario-mejorado">
                Transacción: {{ compraSeleccionada.numero_transaccion }}
              </div>
              <div *ngIf="compraSeleccionada.banco" class="info-secundario-mejorado">
                Banco: {{ compraSeleccionada.banco }}
              </div>
            </div>
          </div>

          <div class="info-grupo-mejorado">
            <div class="info-item-mejorado">
              <h6>Montos</h6>
              <div *ngIf="compraSeleccionada.descuento_aplicado > 0" class="mb-2">
                <div class="info-secundario-mejorado text-decoration-line-through">
                  Precio original: {{ formatearPrecio(compraSeleccionada.precio_paquete) }}
                </div>
                <div class="text-success fw-semibold">
                  Descuento: -{{ formatearPrecio(compraSeleccionada.descuento_aplicado) }}
                </div>
              </div>
              <div class="fs-4 fw-bold text-dark">
                Total: {{ formatearPrecio(compraSeleccionada.precio_final) }}
              </div>
            </div>

            <div class="info-item-mejorado">
              <h6>Fechas</h6>
              <div class="info-valor-mejorado">Compra: {{ formatearFecha(compraSeleccionada.fecha_compra) }}</div>
              <div class="info-secundario-mejorado">
                Pago: {{ compraSeleccionada.fecha_pago }}
                <span *ngIf="compraSeleccionada.hora_pago"> a las {{ compraSeleccionada.hora_pago }}</span>
              </div>
            </div>

            <div *ngIf="compraSeleccionada.notas_usuario" class="info-item-mejorado">
              <h6>Notas del usuario</h6>
              <div class="info-valor-mejorado">{{ compraSeleccionada.notas_usuario }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Formulario de validación -->
      <form [formGroup]="formularioValidacion" (ngSubmit)="procesarValidacion()" class="formulario-validacion-mejorado">
        <!-- Acción -->
        <div class="grupo-radio-mejorado">
          <label>Acción *</label>
          <div class="radio-grid-mejorado">
            <div class="radio-option-mejorada">
              <input
                type="radio"
                id="validar"
                class="radio-input-mejorado"
                formControlName="accion"
                value="validar">
              <label for="validar" class="radio-label-mejorado validar">
                <i class="fas fa-check radio-icono-mejorado text-success"></i>
                <span class="radio-texto-mejorado text-success">Validar compra</span>
              </label>
            </div>
            
            <div class="radio-option-mejorada">
              <input
                type="radio"
                id="rechazar"
                class="radio-input-mejorado"
                formControlName="accion"
                value="rechazar">
              <label for="rechazar" class="radio-label-mejorado rechazar">
                <i class="fas fa-times radio-icono-mejorado text-danger"></i>
                <span class="radio-texto-mejorado text-danger">Rechazar compra</span>
              </label>
            </div>
          </div>
          <div *ngIf="accionInvalida" class="mensaje-error-mejorado">
            <i class="fas fa-exclamation-circle"></i>
            Por favor selecciona una acción
          </div>
        </div>

        <!-- Motivo de rechazo -->
        <div *ngIf="requiereMotivoRechazo">
          <label for="motivo_rechazo" class="fw-semibold text-dark mb-2 d-block">Motivo del rechazo *</label>
          <textarea
            id="motivo_rechazo"
            class="textarea-mejorado"
            [ngClass]="{'invalido': motivoRechazoInvalido}"
            formControlName="motivo_rechazo"
            rows="3"
            placeholder="Explica el motivo por el cual se rechaza la compra..."></textarea>
          <div *ngIf="motivoRechazoInvalido" class="mensaje-error-mejorado">
            <i class="fas fa-exclamation-circle"></i>
            El motivo del rechazo es requerido
          </div>
        </div>

        <!-- Notas del administrador -->
        <div>
          <label for="notas_admin" class="fw-semibold text-dark mb-2 d-block">Notas del administrador</label>
          <textarea
            id="notas_admin"
            class="textarea-mejorado"
            formControlName="notas_admin"
            rows="3"
            placeholder="Notas adicionales sobre la validación (opcional)"></textarea>
        </div>

        <!-- Alertas informativas -->
        <div *ngIf="accionSeleccionada === 'validar'" class="alerta-mejorada info">
          <i class="fas fa-info-circle"></i>
          <div>
            <strong>Al validar esta compra:</strong>
            <ul class="mb-0 mt-2 ps-3">
              <li>Se asignará automáticamente el paquete al usuario</li>
              <li>El usuario recibirá una notificación</li>
              <li>El paquete aparecerá en su calendario</li>
              <li>Esta acción no se puede deshacer</li>
            </ul>
          </div>
        </div>

        <div *ngIf="accionSeleccionada === 'rechazar'" class="alerta-mejorada warning">
          <i class="fas fa-exclamation-triangle"></i>
          <div>
            <strong>Al rechazar esta compra:</strong>
            <ul class="mb-0 mt-2 ps-3">
              <li>El usuario será notificado del rechazo</li>
              <li>Deberá especificar un motivo claro</li>
              <li>El usuario podrá realizar una nueva compra</li>
              <li>Esta acción no se puede deshacer</li>
            </ul>
          </div>
        </div>

        <!-- Error -->
        <div *ngIf="error" class="alerta-mejorada error">
          <i class="fas fa-exclamation-triangle"></i>
          <span>{{ error }}</span>
        </div>
      </form>
    </div>

    <div class="modal-footer-mejorado">
      <button 
        type="button" 
        class="boton-modal-mejorado boton-cancelar-mejorado" 
        (click)="cerrarModalValidacion()" 
        [disabled]="procesandoValidacion">
        Cancelar
      </button>
      
      <button 
        type="button" 
        class="boton-modal-mejorado"
        [ngClass]="accionSeleccionada === 'rechazar' ? 'boton-rechazar-final-mejorado' : 'boton-validar-final-mejorado'"
        (click)="procesarValidacion()"
        [disabled]="!formularioValidacion.valid || procesandoValidacion">
        
        <div *ngIf="procesandoValidacion" class="d-flex align-items-center">
          <div class="spinner-boton-mejorado me-2"></div>
          Procesando...
        </div>
        
        <div *ngIf="!procesandoValidacion" class="d-flex align-items-center">
          <i [class]="accionSeleccionada === 'validar' ? 'fas fa-check' : 'fas fa-times'" class="me-2"></i>
          {{ accionSeleccionada === 'validar' ? 'Validar Compra' : 'Rechazar Compra' }}
        </div>
      </button>
    </div>
  </div>
</div>

<!-- Modal de comprobante -->
<div *ngIf="mostrarModalComprobante" class="modal-overlay-mejorado" (click)="cerrarModalComprobante()">
  <div class="modal-contenido-mejorado scrollbar-personalizado" (click)="$event.stopPropagation()">
    <div class="modal-header-mejorado">
      <h5 class="modal-titulo-mejorado">
        <i class="fas fa-file-image"></i>
        Comprobante de Pago
      </h5>
      <button type="button" class="boton-cerrar-mejorado" (click)="cerrarModalComprobante()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body-mejorado">
      <div *ngIf="comprobanteActual" class="comprobante-container-mejorado">
        <!-- Imagen -->
        <div *ngIf="comprobanteActual.includes('image')">
          <img [src]="comprobanteActual" [alt]="comprobanteNombre" class="comprobante-imagen-mejorada">
        </div>

        <!-- PDF -->
        <div *ngIf="comprobanteActual.includes('pdf')" class="comprobante-pdf-mejorado">
          <i class="fas fa-file-pdf icono-pdf-mejorado"></i>
          <div class="nombre-archivo-mejorado">{{ comprobanteNombre }}</div>
          <div class="descripcion-archivo-mejorado">Archivo PDF - Descargar para ver el contenido completo</div>
        </div>

        <!-- Info del archivo -->
        <div class="info-archivo-mejorado">
          <div class="nombre-archivo-info-mejorado">{{ comprobanteNombre }}</div>
        </div>
      </div>

      <div *ngIf="!comprobanteActual" class="error-comprobante-mejorado">
        <i class="fas fa-exclamation-triangle icono-error-comprobante-mejorado"></i>
        <p class="mensaje-error-comprobante-mejorado">No se pudo cargar el comprobante</p>
      </div>
    </div>

    <div class="modal-footer-mejorado">
      <button 
        type="button" 
        class="boton-modal-mejorado boton-cancelar-mejorado" 
        (click)="cerrarModalComprobante()">
        Cerrar
      </button>
      
      <button 
        *ngIf="comprobanteActual"
        type="button" 
        class="boton-modal-mejorado boton-descargar-mejorado"
        (click)="descargarComprobante()">
        <i class="fas fa-download me-2"></i>
        Descargar
      </button>
    </div>
  </div>
</div>